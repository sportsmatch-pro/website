---
export interface Props {
  currentLang: string;
  blogBasePath?: string; // Path base per als enllaços (ex: "/ca/blog" o "/blog")
  noCache?: boolean;
}

const { currentLang, blogBasePath = "/blog", noCache = false } = Astro.props;

interface Post {
  id: string;
  title: string;
  content: string;
  excerpt: string;
  slug: string;
  featuredImage?: string;
  status: string;
  publishedAt?: string;
  readingTime: number;
  language: string;
  sports?: Array<{ id: string; name: string }>;
}

interface SportData {
  id: string;
  name: string;
  color?: string;
}

// Carregar articles i sports en paral·lel
const articlesUrl = noCache
  ? `${import.meta.env.API_BASE_URL}articles?language=${currentLang}&noCache=true`
  : `${import.meta.env.API_BASE_URL}articles?language=${currentLang}`;

const [articlesRes, sportsRes] = await Promise.all([
  fetch(articlesUrl),
  fetch(import.meta.env.API_BASE_URL + "sports"),
]);

const posts: Post[] = await articlesRes.json();
const allSportsData = await sportsRes.json();

// Crear un mapa de colors per nom d'esport
const sportColorMap: Record<string, string> = {};
const allAvailableSports: string[] = [];
(allSportsData as SportData[]).forEach((sport) => {
  allAvailableSports.push(sport.name);
  if (sport.color) {
    sportColorMap[sport.name] = sport.color;
  }
});

// Obtenir tots els esports únics dels articles
const sportsWithArticles = Array.from(
  new Set(posts.flatMap((post) => post.sports || []).map((sport) => sport.name))
);

// Ordenar tots els esports disponibles (mostrar tots els filtres)
const allSports = allAvailableSports.sort();

// Traduccions d'esports (clau API → nom traduït)
const sportTranslations: Record<string, Record<string, string>> = {
  "es-ES": {
    soccer: "Fútbol",
    basketball: "Baloncesto",
    handball: "Balonmano",
    volleyball: "Voleibol",
    futsal: "Fútbol Sala",
    rollerHoquey: "Hockey",
    rinkhockey: "Hockey",
    hockey: "Hockey",
    coach: "Equipo técnico",
  },
  "ca-ES": {
    soccer: "Futbol",
    basketball: "Bàsquet",
    handball: "Handbol",
    volleyball: "Voleibol",
    futsal: "Futbol Sala",
    rollerHoquey: "Hoquei",
    rinkhockey: "Hoquei",
    hockey: "Hoquei",
    coach: "Equip tècnic",
  },
  en: {
    soccer: "Soccer",
    basketball: "Basketball",
    handball: "Handball",
    volleyball: "Volleyball",
    futsal: "Futsal",
    rollerHoquey: "Roller Hockey",
    rinkhockey: "Roller Hockey",
    hockey: "Hockey",
    coach: "Staff",
  },
};

// Funció per traduir el nom de l'esport
const translateSportName = (sportKey: string, lang: string): string => {
  const langTranslations =
    sportTranslations[lang as keyof typeof sportTranslations] ||
    sportTranslations["es-ES"];
  return langTranslations[sportKey.toLowerCase()] || sportKey;
};

// Traduccions
const translations = {
  "es-ES": {
    title: "Blog Deportivo",
    readingTime: "Min. de lectura",
    daysAgo: "hace",
    noResults: "No se han encontrado artículos para este deporte.",
    noImage: "Sin imagen",
    locale: "es-ES",
  },
  "ca-ES": {
    title: "Blog Esportiu",
    readingTime: "Min. de lectura",
    daysAgo: "fa",
    noResults: "No s'han trobat articles per a aquest esport.",
    noImage: "Sense imatge",
    locale: "ca-ES",
  },
  en: {
    title: "Sports Blog",
    readingTime: "Min. read",
    daysAgo: "ago",
    noResults: "No articles found for this sport.",
    noImage: "No image",
    locale: "en-US",
  },
};

const t =
  translations[currentLang as keyof typeof translations] ||
  translations["es-ES"];

// Funció per calcular dies fa
const getDaysAgo = (dateString: string | undefined): string => {
  if (!dateString) return "";
  const date = new Date(dateString);
  const now = new Date();
  const diffTime = Math.abs(now.getTime() - date.getTime());
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays === 0) {
    if (currentLang === "en") return "today";
    if (currentLang === "ca-ES") return "avui";
    return "hoy";
  }
  if (diffDays === 1) {
    if (currentLang === "en") return `${t.daysAgo} 1 day`;
    if (currentLang === "ca-ES") return `${t.daysAgo} 1 dia`;
    return `${t.daysAgo} 1 día`;
  }
  if (diffDays < 7) {
    if (currentLang === "en") return `${t.daysAgo} ${diffDays} days`;
    if (currentLang === "ca-ES") return `${t.daysAgo} ${diffDays} dies`;
    return `${t.daysAgo} ${diffDays} días`;
  }

  // Si és més d'una setmana, mostrar data formatada
  return date.toLocaleDateString(t.locale, { day: "numeric", month: "short" });
};
---

<div class="max-w-7xl mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold mb-8 text-center">{t.title}</h1>

  <!-- Filtre per esports -->
  <div class="mb-8 flex flex-wrap gap-2 justify-center" id="sport-filters">
    {
      allSports.map((sport) => {
        const sportColor = sportColorMap[sport] || "#6b7280"; // Gray per defecte
        const translatedSportName = translateSportName(sport, currentLang);
        const hasArticles = sportsWithArticles.includes(sport);
        return (
          <button
            class="sport-filter px-3 py-1.5 text-sm rounded-full font-medium transition-all bg-gray-300 text-gray-700"
            data-sport={sport}
            data-sport-color={sportColor}
            data-has-articles={hasArticles.toString()}
            style={`${!hasArticles ? "opacity: 0.6;" : ""}`}
            title={!hasArticles ? t.noResults : undefined}
          >
            {translatedSportName}
          </button>
        );
      })
    }
  </div>

  <!-- Grid d'articles -->
  <div
    id="articles-grid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
  >
    {
      posts.map((post) => {
        const postSports = (post.sports || []).map((s) => s.name);
        const firstSport = postSports[0] || "";
        const daysAgo = getDaysAgo(post.publishedAt);

        return (
          <article
            class="article-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
            data-sports={JSON.stringify(postSports)}
          >
            <a href={`${blogBasePath}/${post.slug}`}>
              {post.featuredImage ? (
                <img
                  src={post.featuredImage}
                  alt={post.title}
                  class="w-full h-48 object-cover"
                />
              ) : (
                <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                  <span class="text-gray-400">{t.noImage}</span>
                </div>
              )}

              <div class="p-4">
                <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
                  <span>{daysAgo}</span>
                  <span>
                    {post.readingTime} {t.readingTime}
                  </span>
                </div>

                {firstSport && (
                  <span
                    class="inline-block px-3 py-1 text-white text-xs rounded-full mb-2"
                    style={`background-color: ${sportColorMap[firstSport] || "#22c55e"};`}
                  >
                    {translateSportName(firstSport, currentLang)}
                  </span>
                )}

                <h2 class="text-xl font-semibold text-gray-800 mb-2 line-clamp-2">
                  {post.title}
                </h2>

                <p class="text-gray-600 text-sm line-clamp-3">
                  {post.excerpt || post.content.substring(0, 150) + "..."}
                </p>
              </div>
            </a>
          </article>
        );
      })
    }
  </div>

  <!-- Missatge quan no hi ha resultats -->
  <div id="no-results" class="hidden text-center py-12">
    <p class="text-gray-500 text-lg">
      {t.noResults}
    </p>
  </div>
</div>

<style>
  .article-card {
    display: block;
  }
  .article-card a {
    text-decoration: none;
    color: inherit;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .sport-filter {
    opacity: 0.9;
  }
  .sport-filter:hover {
    opacity: 1;
    transform: scale(1.05);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }
  .sport-filter.active-filter {
    opacity: 1 !important;
    transform: scale(1.05);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 2px solid white;
    color: white !important;
  }
</style>

<script>
  // Filtrat d'articles per esport (selecció única)
  const filters = document.querySelectorAll(".sport-filter");
  const articles = document.querySelectorAll(".article-card");
  const noResults = document.getElementById("no-results");
  const articlesGrid = document.getElementById("articles-grid");

  // Variable per emmagatzemar l'esport seleccionat (només un)
  let selectedSport: string | null = null;

  const updateFilters = () => {
    let visibleCount = 0;

    // Si no hi ha cap esport seleccionat, mostrar tots
    if (!selectedSport) {
      articles.forEach((article) => {
        const articleElement = article as HTMLElement;
        articleElement.style.display = "block";
      });

      if (articlesGrid) (articlesGrid as HTMLElement).style.display = "grid";
      if (noResults) noResults.classList.add("hidden");
      return;
    }

    // Filtrar articles segons l'esport seleccionat
    articles.forEach((article) => {
      const articleElement = article as HTMLElement;
      const articleSports = JSON.parse(
        article.getAttribute("data-sports") || "[]"
      );

      if (articleSports.includes(selectedSport)) {
        articleElement.style.display = "block";
        visibleCount++;
      } else {
        articleElement.style.display = "none";
      }
    });

    // Verificar si l'esport seleccionat té articles
    const selectedFilter = document.querySelector(
      `[data-sport="${selectedSport}"]`
    );
    const hasArticles =
      selectedFilter?.getAttribute("data-has-articles") === "true";

    // Mostrar/ocultar missatge de no resultats
    if (visibleCount === 0 || !hasArticles) {
      if (articlesGrid) (articlesGrid as HTMLElement).style.display = "none";
      if (noResults) noResults.classList.remove("hidden");
    } else {
      if (articlesGrid) (articlesGrid as HTMLElement).style.display = "grid";
      if (noResults) noResults.classList.add("hidden");
    }
  };

  filters.forEach((filter) => {
    filter.addEventListener("click", () => {
      const sport = filter.getAttribute("data-sport");
      if (!sport) return;

      // Si ja estava seleccionat, desmarcar-lo
      if (selectedSport === sport) {
        selectedSport = null;
        filter.classList.remove("active-filter");
        const filterEl = filter as HTMLElement;
        filterEl.style.backgroundColor = "";
      } else {
        // Desmarcar tots els altres i restaurar el color gris
        filters.forEach((f) => {
          f.classList.remove("active-filter");
          const fEl = f as HTMLElement;
          fEl.style.backgroundColor = "";
        });

        // Marcar el nou i aplicar el color de l'esport
        selectedSport = sport;
        filter.classList.add("active-filter");
        const filterEl = filter as HTMLElement;
        const sportColor = filter.getAttribute("data-sport-color") || "#6b7280";
        filterEl.style.backgroundColor = sportColor;
      }

      updateFilters();
    });
  });
</script>

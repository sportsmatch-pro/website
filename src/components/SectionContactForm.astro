---
export interface Props {
  currentLang?: string;
}

const { currentLang = "es-ES" } = Astro.props;

// Mapeig d'idiomes per a les URLs
const langMap = {
  "es-ES": { path: "" },
  "ca-ES": { path: "/ca" },
  en: { path: "/en" },
};

const currentLangInfo =
  langMap[currentLang as keyof typeof langMap] || langMap["es-ES"];

const translations = {
  "es-ES": {
    title: "¿Tienes alguna pregunta?",
    subtitle: "Contáctanos y te responderemos lo antes posible",
    nameLabel: "Nombre",
    emailLabel: "Email",
    messageLabel: "Mensaje",
    sendButton: "Enviar mensaje",
    sendingButton: "Enviando...",
    namePlaceholder: "Tu nombre",
    emailPlaceholder: "tu@email.com",
    messagePlaceholder: "Tu mensaje...",
    successMessage:
      "¡Gracias! Hemos recibido tu mensaje y te responderemos pronto.",
    errorMessage: "Error al enviar el mensaje. Por favor, inténtalo de nuevo.",
    privacyConsent: "Para continuar, debes aceptar nuestra",
    privacyPolicy: "política de privacidad",
    and: "y nuestra",
    cookiesPolicy: "política de cookies",
    privacyUrl: "/politica-de-privacidad",
    cookiesUrl: "/cookies",
  },
  "ca-ES": {
    title: "Tens alguna pregunta?",
    subtitle: "Contacta'ns i et respondrem el més aviat possible",
    nameLabel: "Nom",
    emailLabel: "Email",
    messageLabel: "Missatge",
    sendButton: "Enviar missatge",
    sendingButton: "Enviant...",
    namePlaceholder: "El teu nom",
    emailPlaceholder: "tu@email.com",
    messagePlaceholder: "El teu missatge...",
    successMessage: "Gràcies! Hem rebut el teu missatge i et respondrem aviat.",
    errorMessage:
      "Error en enviar el missatge. Si us plau, torna-ho a intentar.",
    privacyConsent: "Per continuar, has d'acceptar la nostra",
    privacyPolicy: "política de privacitat",
    and: "i la nostra",
    cookiesPolicy: "política de cookies",
    privacyUrl: "/ca/politica-de-privacitat",
    cookiesUrl: "/ca/cookies",
  },
  en: {
    title: "Do you have any questions?",
    subtitle: "Contact us and we'll get back to you as soon as possible",
    nameLabel: "Name",
    emailLabel: "Email",
    messageLabel: "Message",
    sendButton: "Send message",
    sendingButton: "Sending...",
    namePlaceholder: "Your name",
    emailPlaceholder: "your@email.com",
    messagePlaceholder: "Your message...",
    successMessage:
      "Thank you! We've received your message and will reply soon.",
    errorMessage: "Error sending message. Please try again.",
    privacyConsent: "To continue, you must accept our",
    privacyPolicy: "privacy policy",
    and: "and our",
    cookiesPolicy: "cookies policy",
    privacyUrl: "/en/privacy-policy",
    cookiesUrl: "/en/cookies",
  },
};

const t =
  translations[currentLang as keyof typeof translations] ||
  translations["es-ES"];
---

<section class="bg-gray-50 py-20" id="contact">
  <div class="max-w-4xl mx-auto px-4">
    <div class="text-center mb-16">
      <h2 class="text-5xl font-bold text-gray-900 mb-6">
        {t.title}
      </h2>
      <p class="text-xl text-gray-600">
        {t.subtitle}
      </p>
    </div>

    <form
      id="contact-form"
      class="bg-white rounded-lg shadow-lg p-8"
      data-lang={currentLang}
    >
      <div id="message-container" class="mb-4"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label
            for="name"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            {t.nameLabel}
          </label>
          <input
            type="text"
            id="name"
            name="name"
            placeholder={t.namePlaceholder}
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
            required
          />
        </div>

        <div>
          <label
            for="email"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            {t.emailLabel}
          </label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder={t.emailPlaceholder}
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
            required
          />
        </div>
      </div>

      <div class="mb-6">
        <label
          for="message"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          {t.messageLabel}
        </label>
        <textarea
          id="message"
          name="message"
          rows="6"
          placeholder={t.messagePlaceholder}
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent resize-none"
          required></textarea>
      </div>

      <!-- Checkbox de consentiment -->
      <div class="mb-6">
        <label class="flex items-start">
          <input
            type="checkbox"
            id="privacy-checkbox"
            name="privacy"
            class="mt-1 mr-3 w-5 h-5 text-gray-600 border-gray-300 rounded focus:ring-gray-500"
            required
          />
          <span class="text-sm text-gray-700">
            {t.privacyConsent}{" "}
            <a
              href={t.privacyUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-gray-200 underline"
            >
              {t.privacyPolicy}
            </a>{" "}
            {t.and}{" "}
            <a
              href={t.cookiesUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-gray-200 underline"
            >
              {t.cookiesPolicy}
            </a>
          </span>
        </label>
      </div>

      <div class="text-center">
        <button
          type="submit"
          id="submit-btn"
          class="bg-gray-500 text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
          disabled
        >
          {t.sendButton}
        </button>
      </div>
    </form>
  </div>
</section>

<script is:inline>
  const contactForm = document.getElementById("contact-form");
  const submitBtn = document.getElementById("submit-btn");
  const messageContainer = document.getElementById("message-container");
  const privacyCheckbox = document.getElementById("privacy-checkbox");

  const translations = {
    "es-ES": {
      sendingButton: "Enviando...",
      successMessage:
        "¡Gracias! Hemos recibido tu mensaje y te responderemos pronto.",
      errorMessage:
        "Error al enviar el mensaje. Por favor, inténtalo de nuevo.",
      sendButton: "Enviar mensaje",
    },
    "ca-ES": {
      sendingButton: "Enviant...",
      successMessage:
        "Gràcies! Hem rebut el teu missatge i et respondrem aviat.",
      errorMessage:
        "Error en enviar el missatge. Si us plau, torna-ho a intentar.",
      sendButton: "Enviar missatge",
    },
    en: {
      sendingButton: "Sending...",
      successMessage:
        "Thank you! We've received your message and will reply soon.",
      errorMessage: "Error sending message. Please try again.",
      sendButton: "Send message",
    },
  };

  // Llegir el idioma del data-lang del formulari
  const currentLang = contactForm
    ? contactForm.getAttribute("data-lang")
    : "es-ES";
  const t = translations[currentLang] || translations["es-ES"];

  if (!contactForm || !submitBtn || !messageContainer) {
    console.error("Error: No es poden trobar els elements del formulari");
  }

  // Determinar l'URL de l'API segons l'entorn
  const getApiUrl = () => {
    // Si estem en localhost, usar el tunnel de Cloudflare
    if (
      window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1"
    ) {
      return "https://api.sportsmatch.top/api/";
    }
    // Si estem en un entorn de desenvolupament
    if (window.location.hostname.includes(".dev")) {
      return "https://api.sportsmatch.dev/api/";
    }
    // Per defecte, producció
    return "https://api.sportsmatch.pro/api/";
  };

  const API_BASE_URL = getApiUrl();

  const showMessage = (message, isError = false) => {
    if (!messageContainer) return;

    messageContainer.innerHTML = `
      <div class="p-4 rounded-lg ${isError ? "bg-red-50 border border-red-200 text-red-800" : "bg-green-50 border border-green-200 text-green-800"}">
        <p class="text-center">${message}</p>
      </div>
    `;

    if (!isError && contactForm) {
      contactForm.reset();
      // Desactivar el botó després del reset
      if (submitBtn) {
        submitBtn.disabled = true;
      }
    }

    setTimeout(() => {
      if (messageContainer) {
        messageContainer.innerHTML = "";
      }
    }, 5000);
  };

  // Activar/desactivar botó segons checkbox
  if (privacyCheckbox && submitBtn) {
    privacyCheckbox.addEventListener("change", (e) => {
      if (e.target && "checked" in e.target) {
        submitBtn.disabled = !e.target.checked;
      }
    });
  }

  if (contactForm) {
    contactForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(contactForm);
      const data = {
        name: formData.get("name"),
        email: formData.get("email"),
        message: formData.get("message"),
      };

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = t.sendingButton;
      }

      try {
        const response = await fetch(`${API_BASE_URL}send-mails/contact`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error("Error en la respuesta del servidor");
        }

        showMessage(t.successMessage, false);
      } catch (error) {
        console.error("Error enviando formulario:", error);
        showMessage(t.errorMessage, true);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = t.sendButton;
        }
      }
    });
  }
</script>

---
import Layout from "../../layouts/Layout.astro";
import { processTweetEmbeds } from "../../utils/tweetEmbed";

interface Post {
  id: string;
  title: string;
  content: string;
  excerpt: string;
  slug: string;
  featuredImage?: string;
  status: string;
  publishedAt?: string;
  readingTime: number;
  language: string;
  sports?: Array<{ id: string; name: string }>;
}

export async function getStaticPaths() {
  // Cridar l'API per obtenir tots els articles
  const res = await fetch(import.meta.env.API_BASE_URL + "articles");
  const posts = await res.json();

  // Generar una ruta per a cada article
  return posts.map((post: Post) => ({
    params: { slug: post.slug },
    props: { post, allPosts: posts },
  }));
}

// Les props es reben automàticament
const { post, allPosts } = Astro.props as { post: Post; allPosts: Post[] };

console.error(" Building route for slug:", post.slug);
console.error("✅ Post data received:", post.title);

// Processar el contingut per convertir tweets
const processedContent = processTweetEmbeds(post.content);

// Traduccions
const translations = {
  "es-ES": {
    readingTime: "Tiempo de lectura:",
    minutes: "minutos",
    publicationDate: "Fecha de publicación:",
    locale: "es-ES",
  },
  "ca-ES": {
    readingTime: "Temps de lectura:",
    minutes: "minuts",
    publicationDate: "Data de publicació:",
    locale: "ca-ES",
  },
  en: {
    readingTime: "Reading time:",
    minutes: "minutes",
    publicationDate: "Publication date:",
    locale: "en-US",
  },
};

const lang = post.language as keyof typeof translations;
const t = translations[lang] || translations["es-ES"];
---

<Layout
  title={post.title}
  description={post.excerpt}
  currentLang={post.language}
>
  <article class="prose max-w-4xl mx-auto px-4 py-8">
    {
      post.featuredImage && (
        <img
          src={post.featuredImage}
          alt={post.title}
          class="w-full h-96 object-cover rounded-lg mb-6"
        />
      )
    }

    <div class="mb-6 text-gray-600">
      {
        post.readingTime > 0 && (
          <p class="mb-2">
            <strong>{t.readingTime}</strong> {post.readingTime} {t.minutes}
          </p>
        )
      }
      {
        post.publishedAt && (
          <p class="mb-2">
            <strong>{t.publicationDate}</strong>{" "}
            {new Date(post.publishedAt).toLocaleDateString(t.locale)}
          </p>
        )
      }
    </div>
    <h1 class="text-4xl font-bold mb-6">{post.title}</h1>

    <div class="article-content" set:html={processedContent} />
  </article>

  <!-- Script de Twitter widgets.js per renderitzar els embeds -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"
  ></script>

  <script is:inline>
    // Funció per assegurar que els widgets es carreguen correctament
    window.addEventListener("load", function () {
      if (typeof window.twttr !== "undefined" && window.twttr.widgets) {
        // Carregar tots els widgets que no s'han renderitzat encara
        window.twttr.widgets.load();
      } else if (typeof window.twttr !== "undefined" && window.twttr.ready) {
        // Si el script està carregant, esperar a que estigui llest
        window.twttr.ready(function (twttr) {
          twttr.widgets.load();
        });
      }
    });
  </script>
</Layout>

<style is:global>
  .article-content {
    max-width: 100%;
  }
  .article-content h2 {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    margin-top: 1.5rem !important;
    margin-bottom: 1rem !important;
    line-height: 1.75 !important;
  }
  .article-content h2:first-child {
    margin-top: 0 !important;
  }
  .article-content ul,
  .article-content ol {
    margin-top: 1rem !important;
    margin-bottom: 1rem !important;
    padding-left: 1.5rem !important;
  }
  .article-content ul {
    list-style-type: disc !important;
  }
  .article-content ol {
    list-style-type: decimal !important;
  }
  .article-content li {
    margin-bottom: 0.5rem !important;
    line-height: 1.75 !important;
  }
  .article-content p {
    margin-bottom: 1rem !important;
    line-height: 1.75 !important;
  }
  .article-content img {
    max-width: 100% !important;
    height: auto !important;
    border-radius: 0.5rem !important;
    margin-top: 1rem !important;
    margin-bottom: 1rem !important;
  }
  /* Estils per als embeds de Twitter */
  .article-content blockquote.twitter-tweet {
    margin: 1.5rem auto !important;
    max-width: 550px !important;
    display: block !important;
    text-align: center !important;
  }
  .article-content blockquote.twitter-tweet > * {
    text-align: left !important;
  }
</style>

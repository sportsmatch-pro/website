---
import Layout from "../../../layouts/Layout.astro";

interface Post {
  id: string;
  title: string;
  content: string;
  excerpt: string;
  slug: string;
  featuredImage?: string;
  status: string;
  publishedAt?: string;
  readingTime: number;
  language: string;
  sports?: Array<{ id: string; name: string }>;
}

export async function getStaticPaths() {
  // Cridar l'API per obtenir articles en català
  const res = await fetch(
    import.meta.env.API_BASE_URL + "articles?language=ca-ES"
  );
  const posts = await res.json();

  // Generar rutes per a articles en català
  return posts.map((post: Post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// Les props es reben automàticament
const { post } = Astro.props as { post: Post };

console.error(" Building route for slug:", post.slug);
console.error("✅ Post data received:", post.title);
---

<Layout title={post.title} description={post.excerpt} currentLang="ca-ES">
  <article class="prose max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-6">{post.title}</h1>

    {
      post.featuredImage && (
        <img
          src={post.featuredImage}
          alt={post.title}
          class="w-full h-64 object-cover rounded-lg mb-6"
        />
      )
    }

    <div class="mb-6 text-gray-600">
      <p class="mb-2"><strong>Extracte:</strong> {post.excerpt}</p>
      {
        post.readingTime > 0 && (
          <p class="mb-2">
            <strong>Temps de lectura:</strong> {post.readingTime} minuts
          </p>
        )
      }
      {
        post.publishedAt && (
          <p class="mb-2">
            <strong>Data de publicació:</strong>{" "}
            {new Date(post.publishedAt).toLocaleDateString("ca-ES")}
          </p>
        )
      }
      {
        post.sports && post.sports.length > 0 && (
          <div class="mb-4">
            <strong>Esports:</strong>
            <div class="flex gap-2 mt-2">
              {post.sports.map((sport) => (
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                  {sport.name}
                </span>
              ))}
            </div>
          </div>
        )
      }
    </div>

    <div class="prose prose-lg max-w-none">
      {
        post.content
          .split("\n\n")
          .map((paragraph, index) => (
            <p class="mb-4 leading-relaxed">{paragraph}</p>
          ))
      }
    </div>
  </article>

  <!-- Script de Twitter per renderitzar els embeds -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"
  ></script>

  <script is:inline>
    // Assegurar que els widgets de Twitter es carreguen després que el DOM estigui llest
    window.addEventListener("load", () => {
      if (window.twttr && window.twttr.widgets) {
        window.twttr.widgets.load();
      }
    });

    // També intentar carregar quan el script estigui disponible
    if (typeof window.twttr !== "undefined") {
      window.twttr.ready(() => {
        window.twttr.widgets.load();
      });
    }
  </script>
</Layout>

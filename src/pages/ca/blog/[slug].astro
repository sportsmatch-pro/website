---
import Layout from "../../../layouts/Layout.astro";
import { processTweetEmbeds } from "../../../utils/tweetEmbed";

interface Post {
  id: string;
  title: string;
  content: string;
  excerpt: string;
  slug: string;
  featuredImage?: string;
  status: string;
  publishedAt?: string;
  readingTime: number;
  language: string;
  sports?: Array<{ id: string; name: string }>;
}

export async function getStaticPaths() {
  // Cridar l'API per obtenir articles en català
  const res = await fetch(
    import.meta.env.API_BASE_URL + "articles?language=ca-ES"
  );
  const posts = await res.json();

  // Generar rutes per a articles en català
  return posts.map((post: Post) => ({
    params: { slug: post.slug },
    props: { post, allPosts: posts },
  }));
}

// Les props es reben automàticament
const { post, allPosts } = Astro.props as { post: Post; allPosts: Post[] };

console.error(" Building route for slug:", post.slug);
console.error("✅ Post data received:", post.title);

// Processar el contingut per convertir tweets
const processedContent = processTweetEmbeds(post.content);

// Obtenir les tres últimes entrades (excloent l'actual i només del mateix idioma)
const getLatestPosts = (
  posts: Post[],
  currentPost: Post,
  limit: number = 3
): Post[] => {
  return posts
    .filter(
      (p) =>
        p.id !== currentPost.id &&
        p.status === "published" &&
        p.language === currentPost.language
    )
    .sort((a, b) => {
      const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : 0;
      const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : 0;
      return dateB - dateA;
    })
    .slice(0, limit);
};

const latestPosts = getLatestPosts(allPosts, post, 3);

// Carregar esports per obtenir colors
const sportsRes = await fetch(import.meta.env.API_BASE_URL + "sports");
const allSportsData = await sportsRes.json();

interface SportData {
  id: string;
  name: string;
  color?: string;
}

const sportColorMap: Record<string, string> = {};
(allSportsData as SportData[]).forEach((sport) => {
  if (sport.color) {
    sportColorMap[sport.name] = sport.color;
  }
});

// Traduccions d'esports
const sportTranslations: Record<string, Record<string, string>> = {
  "ca-ES": {
    soccer: "Futbol",
    basketball: "Bàsquet",
    handball: "Handbol",
    volleyball: "Voleibol",
    futsal: "Futbol Sala",
    rollerHoquey: "Hoquei",
    rinkhockey: "Hoquei",
    hockey: "Hoquei",
    coach: "Equip tècnic",
  },
};

const translateSportName = (sportKey: string, lang: string): string => {
  const langTranslations =
    sportTranslations[lang as keyof typeof sportTranslations] ||
    sportTranslations["ca-ES"];
  return langTranslations[sportKey.toLowerCase()] || sportKey;
};

// Funció per calcular dies fa
const getDaysAgo = (dateString: string | undefined): string => {
  if (!dateString) return "";
  const date = new Date(dateString);
  const now = new Date();
  const diffTime = Math.abs(now.getTime() - date.getTime());
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "avui";
  if (diffDays === 1) return `fa 1 dia`;
  if (diffDays < 7) return `fa ${diffDays} dies`;
  return date.toLocaleDateString("ca-ES", { day: "numeric", month: "short" });
};

const t = {
  relatedPosts: "Últimes entrades",
  minRead: "Min. de lectura",
  noImage: "Sense imatge",
};
---

<Layout title={post.title} description={post.excerpt} currentLang="ca-ES">
  <article class="prose max-w-4xl mx-auto px-4 py-8">
    {
      post.featuredImage && (
        <img
          src={post.featuredImage}
          alt={post.title}
          class="w-full h-96 object-cover rounded-lg mb-6"
        />
      )
    }

    <div class="mb-6 text-gray-600">
      {
        post.readingTime > 0 && (
          <p class="mb-2">
            <strong>Temps de lectura:</strong> {post.readingTime} minuts
          </p>
        )
      }
      {
        post.publishedAt && (
          <p class="mb-2">
            <strong>Data de publicació:</strong>{" "}
            {new Date(post.publishedAt).toLocaleDateString("ca-ES", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })}
          </p>
        )
      }
    </div>

    <h1 class="text-4xl font-bold mb-6">{post.title}</h1>
    <div class="article-content" set:html={processedContent} />
  </article>

  <!-- Últimes entrades -->
  {
    latestPosts.length > 0 && (
      <section class="max-w-7xl mx-auto px-4 py-8 mt-12 border-t border-gray-200">
        <h2 class="text-3xl font-bold mb-8 text-center">{t.relatedPosts}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {latestPosts.map((relatedPost) => {
            const postSports = (relatedPost.sports || []).map((s) => s.name);
            const firstSport = postSports[0] || "";
            const daysAgo = getDaysAgo(relatedPost.publishedAt);

            return (
              <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                <a href={`/ca/blog/${relatedPost.slug}`} class="block">
                  {relatedPost.featuredImage ? (
                    <img
                      src={relatedPost.featuredImage}
                      alt={relatedPost.title}
                      class="w-full h-48 object-cover"
                    />
                  ) : (
                    <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                      <span class="text-gray-400">{t.noImage}</span>
                    </div>
                  )}

                  <div class="p-4">
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
                      <span>{daysAgo}</span>
                      <span>
                        {relatedPost.readingTime} {t.minRead}
                      </span>
                    </div>

                    {firstSport && (
                      <span
                        class="inline-block px-3 py-1 text-white text-xs rounded-full mb-2"
                        style={`background-color: ${sportColorMap[firstSport] || "#22c55e"};`}
                      >
                        {translateSportName(firstSport, "ca-ES")}
                      </span>
                    )}

                    <h3 class="text-xl font-semibold text-gray-800 mb-2 line-clamp-2">
                      {relatedPost.title}
                    </h3>

                    <p class="text-gray-600 text-sm line-clamp-3">
                      {relatedPost.excerpt ||
                        relatedPost.content.substring(0, 150) + "..."}
                    </p>
                  </div>
                </a>
              </article>
            );
          })}
        </div>
      </section>
    )
  }

  <!-- Script de Twitter widgets.js per renderitzar els embeds -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"
  ></script>

  <script is:inline>
    // Funció per assegurar que els widgets es carreguen correctament
    window.addEventListener("load", function () {
      if (typeof window.twttr !== "undefined" && window.twttr.widgets) {
        // Carregar tots els widgets que no s'han renderitzat encara
        window.twttr.widgets.load();
      } else if (typeof window.twttr !== "undefined" && window.twttr.ready) {
        // Si el script està carregant, esperar a que estigui llest
        window.twttr.ready(function (twttr) {
          twttr.widgets.load();
        });
      }
    });
  </script>
</Layout>

<style is:global>
  .article-content {
    max-width: 100%;
  }
  .article-content h2 {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    margin-top: 1.5rem !important;
    margin-bottom: 1rem !important;
    line-height: 1.75 !important;
  }
  .article-content h2:first-child {
    margin-top: 0 !important;
  }
  .article-content ul,
  .article-content ol {
    margin-top: 1rem !important;
    margin-bottom: 1rem !important;
    padding-left: 1.5rem !important;
  }
  .article-content ul {
    list-style-type: disc !important;
  }
  .article-content ol {
    list-style-type: decimal !important;
  }
  .article-content li {
    margin-bottom: 0.5rem !important;
    line-height: 1.75 !important;
  }
  .article-content p {
    margin-bottom: 1rem !important;
    line-height: 1.75 !important;
  }
  .article-content img {
    max-width: 100% !important;
    height: auto !important;
    border-radius: 0.5rem !important;
    margin-top: 1rem !important;
    margin-bottom: 1rem !important;
  }
  /* Estils per als embeds de Twitter */
  .article-content blockquote.twitter-tweet {
    margin: 1.5rem auto !important;
    max-width: 550px !important;
    display: block !important;
    text-align: center !important;
  }
  .article-content blockquote.twitter-tweet > * {
    text-align: left !important;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
